{% extends 'base.html' %}
{% load static %}

{% block head %}
    <title>{{lesson.title}} | {{course.title}}</title>
    <link rel="stylesheet" href="{% static 'lesson.css' %}">
{% endblock %}

{% block title %}
<div class="two-row-nav-title">
    <h1>{{ lesson.title }}</h1>
    <p style="cursor: pointer;" onclick="window.location.href = '{% url 'course' id=course.id %}'" class="secondary">{{ course.title }}</p>
</div>
{% endblock %}


{% block content %}
 
    <div class="lesson-content">
        {% block lesson %}
        
        {% endblock%}
    </div>
    <br><br><br>
    <div class="lesson-end">
        {% if not isComplete %}
        <form action="{% url 'finishLesson' id=lesson.id %}" method="post">
            {% csrf_token %}
            <button class="filled"><i class="material-icons">check_circle</i> &nbsp;  L√µpeta tund</button>
            
        </form>
        {% else %}
            <i>See tund on juba l√µpetatud!</i>
            
        {% endif %}
    </div>
    <br><br>

    <style>
        .question-card-front, .question-card-back{
            transition: all 200ms;
        }

        .question-load-div{
            transition: height 200ms ;
        }
    </style>

    <script>
        var align = "left";
        $(".question-load-div").each(async function (){
            var id = $(this).attr("question-id");

            var url = "{% url 'exercise' id=12345 %}".replace(/12345/, id.toString());

            await $(this).load(url, function (){
                if(align === "left"){
                    $(">.question", this).addClass("question-left");
                    align = "right";
                }else{
                    $(">.question", this).addClass("question-right");
                    align = "left";
                }
            });

        });
        
        setTimeout(() => {
            
            let checker = (arr, target) => target.every(v => arr.includes(v));
            let someChecker = (arr, target) => target.some(v => arr.includes(v));


            $(".question-submit-btn").click(function (){
                var questionId = $(this).attr("question-id");

                

                var choices = $(".question-choices[question-id="+questionId.toString() + "]");

                var answers = [];
                var correctAnswers = [];

                choices.children().each(function (){
                    if($(this).attr("isCorrect") == "true"){
                        correctAnswers.push($(this).attr("choiceId").toString().toLowerCase());
                    }
                    var isChecked = $(this).children().is(":checked");
                    if(isChecked){
                        answers.push($(this).attr("choiceId"));
                    }

                    $(this).children().prop("checked", false);
                });


                var result;


                if($(".question-write[question-id=" + questionId.toString() + "]").length){
                    // Write answer
                    if(correctAnswers.includes($(".question-write[question-id=" + questionId.toString() + "]").val().toLowerCase())){
                        result = "üéâ √ïige vastus!";
                    }else{
                        result = "üëé Vale vastus!";
                    }
                }else{
                    //Not write answer
                    if(checker(answers, correctAnswers)){
                        result = "üéâ √ïige vastus!";
                    }else if(someChecker(answers, correctAnswers)){
                        result = "üòê Pooleldi √µige!";
                    }else{
                        result = "üëé Vale vastus!";
                    }
                }

                

                $(".question-card-back > .question-result[question-id=" + questionId.toString() + "]").text(result);

                $(".question-load-div[question-id=" + questionId.toString() + "] .question > .question-card-front").css("opacity", "0");

                

                setTimeout(() => {
                    $(".question-load-div[question-id=" + questionId.toString() + "] .question > .question-card-front").css("display", "none");
                    $(".question-load-div[question-id=" + questionId.toString() + "] .question > .question-card-back").css("opacity", "0");

                    $(".question-load-div[question-id=" + questionId.toString() + "] .question > .question-card-back").css("display", "block");

                    $(".question-load-div[question-id=" + questionId.toString() + "] .question > .question-card-back").css("opacity", "1");
                }, 200);



            });

            $(".explanation-btn").click(function (){
                var questionId = $(this).attr("question-id");
                $(".explanation[question-id=" + questionId.toString() + "]").toggle();
                if($(".explanation[question-id=" + questionId.toString() + "]").is(":visible")){
                    $(this).text("Peida selgitus")
                }else{
                    $(this).text("Vaata selgitust")

                }
            });

            $(".try-again-btn").click(function (){
                var questionId = $(this).attr("question-id");

                $(".question-load-div[question-id=" + questionId.toString() + "] .question > .question-card-back").css("opacity", "0");
                setTimeout(() => {
                    $(".question-load-div[question-id=" + questionId.toString() + "] .question > .question-card-back").css("display", "none");
                    $(".question-load-div[question-id=" + questionId.toString() + "] .question > .question-card-front").css("display", "block");
                    $(".explanation[question-id=" + questionId.toString() + "]").hide();

                    $(".question-load-div[question-id=" + questionId.toString() + "] .question > .question-card-front").css("opacity", "1");
                }, 200);
            });

            
        }, 1000);

    </script>

{% endblock %}